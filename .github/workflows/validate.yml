name: Ruff + Mypy + Hassfest

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to check'
        required: true
        default: 'main'
      fix:
        description: 'Run ruff with --fix (will apply auto-fixes in the workspace)'
        required: true
        default: false
        type: boolean

jobs:
  lint-type-validate:
    runs-on: ubuntu-latest

    steps:
      # Checkout the selected branch when invoked via workflow_dispatch
      - name: Checkout (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      # Checkout normally for push / pull_request events
      - name: Checkout (push/pr)
        if: github.event_name != 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Ruff
        run: |
          echo "Running ruff on branch: ${GITHUB_REF}"
          # If this is a workflow_dispatch invocation, respect the `fix` input; otherwise run without --fix
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.fix }}" = "true" ]; then
            echo "Applying ruff --fix (automatic fixes)"
            # allow non-zero exit from --fix command (it may still leave issues); final check follows
            ruff check . --fix || true
            echo "Running final ruff check..."
            ruff check .
          else
            echo "Running ruff check without --fix"
            ruff check .
          fi

      - name: Run Mypy
        run: mypy --config-file mypy.ini

      - name: Run Hassfest
        uses: home-assistant/actions/hassfest@master
